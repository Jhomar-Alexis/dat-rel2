<!DOCTYPE html>
<html>
  <head>
    <title>Gráficas en tiempo real</title>
  </head>
  <body style="display: grid; justify-content: center; background-color: black">
    <br />
    <h1
      style="
        color: white;
        text-align: center;
        font-weight: bold;
        font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
        letter-spacing: 3px;
        font-size: 50px;
      "
    >
      DATOS EN TIEMPO REAL
    </h1>
    <div
      id="lineal-chart"
      style="width: 1000px; height: 500px; background: greenyellow"
    ></div>
    <br />
    <div
      id="bar-chart"
      style="width: 1000px; height: 500px; background: orange"
    ></div>
    <br />
    <div
      id="histogram-chart"
      style="width: 1000px; height: 500px; background-color: yellow"
    ></div>
    <br />

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script type="text/javascript">
      var linealChart = echarts.init(document.getElementById("lineal-chart"));
      var barChart = echarts.init(document.getElementById("bar-chart"));
      var histogramChart = echarts.init(
        document.getElementById("histogram-chart")
      );

      // Aquí es donde deberías construir tus gráficas con los datos proporcionados
      var linealData = [];
      var barData = [];
      var histogramData = [];

      const socket = io.connect("http://localhost:3000");

      socket.on("connect", () => {
        console.log("socket conectado");
      });

      //GRAFICA DE OLA
      socket.on("data", function (data) {
        const dt = { ...data, value: data.value.toFixed(2) };

        //lineal
        updateLinealChart(dt);

        //barras
        updatedBarChart(dt);

        //histograma
        updateHistogram(dt);
      });

      function updateLinealChart(data) {
        if (linealData.length % 100 === 0) {
          linealData = linealData.slice(-80);
        }
        linealData.push(data);
        const LinealOption = {
          xAxis: {
            type: "category",
            data: linealData.map((t) => new Date(t.timestamp).toLocaleString()),
          },
          yAxis: {
            type: "value",
          },
          series: [
            {
              name:"G. onda",
              data: linealData.map((t) => t.value),
              type: "line",
              smooth: true,
            },
          ],
          tooltip: {
            show: true,
            trigger: "axis",
          },
        };
        linealChart.setOption(LinealOption);
      }

      function updatedBarChart(data) {
        const tiempo = new Date(data.timestamp);
        if (tiempo.getMinutes() % 2 === 0) {
          const index = barData.findIndex(
            (e) => new Date(e.timestamp).getMinutes() == tiempo.getMinutes()
          );
          if (index >= 0) {
            barData[index].value = data.value;
          } else barData.push(data);
        }
        const barOption = {
          xAxis: {
            type: "category",
            data: barData.map((t) => new Date(t.timestamp).toLocaleString()),
          },
          yAxis: {
            type: "value",
          },
          series: [
            {
              name:"G. barras",
              data: barData.map((t) => t.value),
              type: "bar",
              smooth: true,
              label: {
                show: true,
                position: "top",
              },
            },
          ],
          tooltip: {
            show: true,
            trigger: "axis",
          },
        };
        barChart.setOption(barOption);
      }

      function updateHistogram(data) {
        histogramData.push(data.value);
        var bins = 10;
        var min = Math.min(...histogramData);
        var max = Math.max(...histogramData);
        var binSize = (max - min) / bins;
        var histogram = new Array(bins).fill(0);

        for (var i = 0; i < histogramData.length; i++) {
          var binIndex = Math.floor((histogramData[i] - min) / binSize);
          if (binIndex >= bins) {
            binIndex = bins - 1;
          }
          histogram[binIndex]++;
        }

        var yAxisData = [];
        var seriesData = [];
        for (var i = 0; i < bins; i++) {
          yAxisData.push(
            (min + i * binSize).toFixed(2) +
              ";" +
              (min + (i + 1) * binSize).toFixed(2)
          );
          seriesData.push(histogram[i]);
        }

        const histogramOption = {
          xAxis: {
            type: "category",
            axisLabel: {
              rotate: -60,
            },
            data: yAxisData,
          },
          yAxis: {
            type: "value",
          },
          series: [
            {
              name: "Histograma",
              type: "bar",
              data: seriesData.sort((a, b) => b - a),
              label: {
                show: true,
                position: "top",
              },
            },
          ],
          grid: {
            bottom: "20%",
          },
          tooltip: {
            show: true,
            trigger: "axis",
          },
        };
        histogramChart.setOption(histogramOption);
      }
    </script>
  </body>
</html>
